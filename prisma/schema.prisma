// Echo Marketplace - Complete Prisma Schema
// Production-ready AI Agent Marketplace Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE IDENTITY MODELS
// ============================================================================

model Agent {
  id                String   @id @default(cuid())
  did               String   @unique // Decentralized Identifier
  publicKey         String
  platform          Platform
  platformAgentId   String?  // ID on external platform (n8n workflow ID, etc.)
  platformConfig    Json?    // Platform-specific configuration
  name              String
  description       String?  @db.Text
  capabilities      Json     // { skills: [], tools: [], languages: [] }
  endpoints         Json     // { webhook: "...", api: "..." }
  region            String?  // Data residency region
  
  // Ownership
  ownerUserId       String
  owner             User     @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  orgId             String?
  organization      Organization? @relation(fields: [orgId], references: [id])
  
  // Status
  status            AgentStatus @default(ACTIVE)
  lastSeenAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  credentials       VerifiableCredential[]
  reputationScores  ReputationScore[]
  stakePositions    StakePosition[]
  bids              Bid[]
  taskAssignments   TaskAssignment[]
  attestations      Attestation[]
  listing           AgentListing?
  reviews           AgentReview[]
  payouts           Payout[]
  policyDecisions   PolicyDecision[]
  auditEvents       AuditEvent[]
  
  @@index([did])
  @@index([platform])
  @@index([status])
  @@index([ownerUserId])
  @@index([orgId])
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  passwordHash      String?  // Nullable for SSO-only users
  name              String?
  role              UserRole @default(BUYER)
  
  // Optional DID for users
  did               String?  @unique
  publicKey         String?
  
  // Organization membership
  organizationId    String?
  
  // SCIM provisioning
  scimId            String?  @unique
  scimActive        Boolean? @default(true)
  metadata          Json?    // Additional user metadata
  
  emailVerified     DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  ownedAgents       Agent[]
  createdTasks      Task[]
  attestations      Attestation[]
  reviews           AgentReview[]
  orgMemberships    OrganizationMember[]
  createdPolicies   PolicyPack[]
  approvalRequests  ApprovalRequest[] @relation("ApprovalRequester")
  approvals         ApprovalRequest[] @relation("Approver")
  auditEvents       AuditEvent[]
  analyticsEvents   AnalyticsEvent[]
  
  @@index([email])
  @@index([role])
}

model Organization {
  id                    String   @id @default(cuid())
  name                  String
  did                   String   @unique
  publicKey             String
  industry              String?
  
  // Enterprise Configuration
  ssoEnabled            Boolean? @default(false)
  ssoProvider           String?  // okta, azure, google, onelogin, custom
  ssoConfig             Json?    // SAML metadata, SCIM endpoints
  scimToken             String?  // Hashed SCIM bearer token
  scimTokenCreatedAt    DateTime?
  rbacConfig            Json?    // Custom role definitions
  billingConfig         Json?    // Cost centers, budget caps
  dataRegion            String?  // Primary data region
  dataResidencyRegions  String[] // ["EU", "US"]
  encryptionKeyId       String?  // Customer-managed encryption key ID
  metadata              Json?    // General purpose metadata (roles, encryption keys, groups, etc.)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  agents                Agent[]
  members               OrganizationMember[]
  tasks                 Task[]
  policyPacks           PolicyPack[]
  approvalRequests      ApprovalRequest[]
  
  @@index([did])
}

model OrganizationMember {
  id              String   @id @default(cuid())
  orgId           String
  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role            OrgRole
  permissions     String[] // Granular permissions
  
  joinedAt        DateTime @default(now())
  
  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
}

// ============================================================================
// REPUTATION & TRUST MODELS
// ============================================================================

model VerifiableCredential {
  id          String   @id @default(cuid())
  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  issuerDid   String   // Who issued this credential
  type        CredentialType
  claims      Json     // The actual credential claims
  
  issuedAt    DateTime @default(now())
  expiresAt   DateTime?
  revoked     Boolean  @default(false)
  revokedAt   DateTime?
  signature   String   // Cryptographic proof
  
  @@index([agentId])
  @@index([type])
  @@index([revoked])
}

model ReputationScore {
  id                String   @id @default(cuid())
  agentId           String
  agent             Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  // Overall & Dimensional Scores (0-100)
  overallScore      Float
  performanceScore  Float
  complianceScore   Float
  stakeScore        Float
  verificationScore Float
  
  dimensions        Json     // Additional custom dimensions
  period            ScorePeriod
  calculatedAt      DateTime @default(now())
  
  @@unique([agentId, period])
  @@index([agentId])
  @@index([overallScore])
}

model StakePosition {
  id              String   @id @default(cuid())
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  amount          Float
  currency        String   @default("USD")
  
  lockedAt        DateTime @default(now())
  unlockableAt    DateTime
  status          StakeStatus @default(ACTIVE)
  
  slashHistory    Json     // Array of slash events
  
  @@index([agentId])
  @@index([status])
}

model Attestation {
  id                String   @id @default(cuid())
  agentId           String
  agent             Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  attestorUserId    String
  attestor          User     @relation(fields: [attestorUserId], references: [id], onDelete: Cascade)
  
  category          String   // "reliability", "communication", "quality"
  score             Int      // 1-5
  comment           String?  @db.Text
  verificationProof Json?    // Optional cryptographic proof
  
  createdAt         DateTime @default(now())
  
  @@index([agentId])
  @@index([attestorUserId])
}

// ============================================================================
// AUCTION & TASK MODELS
// ============================================================================

model Task {
  id                  String   @id @default(cuid())
  
  buyerUserId         String
  buyer               User     @relation(fields: [buyerUserId], references: [id], onDelete: Cascade)
  orgId               String?
  organization        Organization? @relation(fields: [orgId], references: [id])
  
  title               String
  description         String   @db.Text
  requirements        Json     // { skills: [], dataClass: "PII", region: "EU" }
  
  maxBudget           Float
  currency            String   @default("USD")
  
  // Auction Configuration
  auctionType         AuctionType
  auctionEndsAt       DateTime?
  
  policyConstraints   Json?    // Custom policy rules for this task
  status              TaskStatus @default(DRAFT)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  bids                Bid[]
  assignment          TaskAssignment?
  policyDecisions     PolicyDecision[]
  auditEvents         AuditEvent[]
  
  @@index([status])
  @@index([auctionEndsAt])
  @@index([buyerUserId])
  @@index([orgId])
}

model Bid {
  id              String   @id @default(cuid())
  taskId          String
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  amount          Float
  currency        String   @default("USD")
  
  // For sealed-bid auctions
  encryptedBid    Json?    // Encrypted bid details
  revealedAt      DateTime?
  
  status          BidStatus @default(PENDING)
  metadata        Json?    // Additional bid metadata
  
  createdAt       DateTime @default(now())
  
  // Relations
  assignment      TaskAssignment?
  
  @@index([taskId])
  @@index([agentId])
  @@index([status])
}

model TaskAssignment {
  id              String   @id @default(cuid())
  taskId          String   @unique
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  agentId         String
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  bidId           String?  @unique
  bid             Bid?     @relation(fields: [bidId], references: [id])
  
  agreedPrice     Float
  currency        String   @default("USD")
  escrowTxId      String?
  
  status          AssignmentStatus @default(ASSIGNED)
  
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  slaDueAt        DateTime?
  
  // Relations
  execution       Execution?
  escrow          EscrowAccount?
  payment         Payment?
  dispute         Dispute?
  review          AgentReview?
  
  @@index([agentId])
  @@index([status])
}

model Execution {
  id                    String   @id @default(cuid())
  taskAssignmentId      String   @unique
  taskAssignment        TaskAssignment @relation(fields: [taskAssignmentId], references: [id], onDelete: Cascade)
  
  platformExecutionId   String?  // External platform's execution ID
  traceId               String?  // OpenTelemetry trace ID
  
  inputHash             String   // Hash of input data
  outputHash            String?  // Hash of output data
  
  startedAt             DateTime @default(now())
  completedAt           DateTime?
  status                ExecutionStatus @default(RUNNING)
  
  errorLog              Json?
  metering              Json?    // { tokens: 1500, apiCalls: 23, duration: 45.2 }
  
  @@index([status])
  @@index([traceId])
}

// ============================================================================
// POLICY & GOVERNANCE MODELS
// ============================================================================

model PolicyPack {
  id              String   @id @default(cuid())
  orgId           String?
  organization    Organization? @relation(fields: [orgId], references: [id])
  
  name            String
  version         String
  rules           Json     // Rego policy rules
  
  createdAt       DateTime @default(now())
  createdByUserId String
  createdBy       User     @relation(fields: [createdByUserId], references: [id])
  
  // Relations
  decisions       PolicyDecision[]
  
  @@index([orgId])
}

model PolicyDecision {
  id              String   @id @default(cuid())
  
  taskId          String?
  task            Task?    @relation(fields: [taskId], references: [id])
  
  agentId         String?
  agent           Agent?   @relation(fields: [agentId], references: [id])
  
  policyPackId    String
  policyPack      PolicyPack @relation(fields: [policyPackId], references: [id])
  
  decision        PolicyDecisionType
  reasonCodes     String[] // ["data_residency_violation", "insufficient_trust"]
  context         Json     // Full evaluation context
  
  decidedAt       DateTime @default(now())
  
  @@index([taskId])
  @@index([agentId])
  @@index([policyPackId])
  @@index([decision])
}

model ApprovalRequest {
  id              String   @id @default(cuid())
  orgId           String
  organization    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  type            ApprovalType
  payload         Json     // Request details
  
  requesterId     String
  requester       User     @relation("ApprovalRequester", fields: [requesterId], references: [id])
  
  approverId      String?
  approver        User?    @relation("Approver", fields: [approverId], references: [id])
  
  status          ApprovalStatus @default(PENDING)
  decision        String?
  reason          String?  @db.Text
  
  createdAt       DateTime @default(now())
  decidedAt       DateTime?
  
  @@index([orgId])
  @@index([status])
}

// ============================================================================
// BILLING & SETTLEMENT MODELS
// ============================================================================

model EscrowAccount {
  id                String   @id @default(cuid())
  taskAssignmentId  String   @unique
  taskAssignment    TaskAssignment @relation(fields: [taskAssignmentId], references: [id], onDelete: Cascade)
  
  amount            Float
  currency          String   @default("USD")
  
  heldAt            DateTime @default(now())
  releasedAt        DateTime?
  status            EscrowStatus @default(HELD)
  
  @@index([status])
}

model Payment {
  id                    String   @id @default(cuid())
  taskAssignmentId      String   @unique
  taskAssignment        TaskAssignment @relation(fields: [taskAssignmentId], references: [id], onDelete: Cascade)
  
  agentId               String
  
  amount                Float
  currency              String   @default("USD")
  
  stripePaymentIntentId String?
  status                PaymentStatus @default(PENDING)
  
  platformFee           Float
  creatorEarnings       Float
  
  paidAt                DateTime?
  
  @@index([status])
  @@index([agentId])
}

model Payout {
  id                    String   @id @default(cuid())
  agentId               String
  agent                 Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  amount                Float
  currency              String   @default("USD")
  
  stripePayoutId        String?
  status                PaymentStatus @default(PENDING)
  taxForm1099Generated  Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  paidAt                DateTime?
  
  @@index([agentId])
  @@index([status])
}

model Dispute {
  id                String   @id @default(cuid())
  taskAssignmentId  String   @unique
  taskAssignment    TaskAssignment @relation(fields: [taskAssignmentId], references: [id], onDelete: Cascade)
  
  reason            String   @db.Text
  evidence          Json     // { buyer: [...], agent: [...] }
  
  status            DisputeStatus @default(OPEN)
  resolution        String?  @db.Text
  refundAmount      Float?
  payoutAmount      Float?
  
  raisedAt          DateTime @default(now())
  resolvedAt        DateTime?
  
  @@index([status])
}

// ============================================================================
// AUDIT & OBSERVABILITY MODELS
// ============================================================================

model AuditEvent {
  id              String   @id @default(cuid())
  eventType       String
  
  agentId         String?
  agent           Agent?   @relation(fields: [agentId], references: [id])
  
  userId          String?
  user            User?    @relation(fields: [userId], references: [id])
  
  taskId          String?
  task            Task?    @relation(fields: [taskId], references: [id])
  
  payload         Json
  
  // Hash chain for tamper detection
  previousHash    String?
  currentHash     String
  sequenceNumber  Int      @unique @default(autoincrement())
  
  timestamp       DateTime @default(now())
  
  @@index([eventType])
  @@index([timestamp])
  @@index([agentId])
  @@index([userId])
  @@index([taskId])
  @@index([sequenceNumber])
}

model MerkleAnchor {
  id              String   @id @default(cuid())
  rootHash        String   @unique
  
  blockchainTxHash String?
  blockNumber     BigInt?
  
  eventRangeStart Int      // Sequence number start
  eventRangeEnd   Int      // Sequence number end
  
  anchoredAt      DateTime @default(now())
  
  @@index([rootHash])
}

// ============================================================================
// DISCOVERY MODELS
// ============================================================================

model AgentListing {
  id                String   @id @default(cuid())
  agentId           String   @unique
  agent             Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  title             String
  shortDescription  String
  longDescription   String   @db.Text
  
  category          String
  tags              String[]
  
  pricingModel      PricingModel
  basePrice         Float?
  
  featured          Boolean  @default(false)
  verified          Boolean  @default(false)
  
  installCount      Int      @default(0)
  avgRating         Float?
  
  lastActiveAt      DateTime @default(now())
  
  @@index([category])
  @@index([featured])
  @@index([verified])
  @@index([avgRating])
}

model AgentReview {
  id                String   @id @default(cuid())
  agentId           String
  agent             Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  buyerUserId       String
  buyer             User     @relation(fields: [buyerUserId], references: [id], onDelete: Cascade)
  
  taskAssignmentId  String   @unique
  taskAssignment    TaskAssignment @relation(fields: [taskAssignmentId], references: [id], onDelete: Cascade)
  
  rating            Int      // 1-5
  review            String?  @db.Text
  verifiedPurchase  Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  
  @@index([agentId])
  @@index([buyerUserId])
}

// ============================================================================
// EVOWORKS MARKETPLACE MODELS (Ghost Flow Integration)
// ============================================================================

// Publisher profile - connects to Ghost Flow account
model Publisher {
  id                String   @id @default(cuid())
  userId            String   @unique
  
  // Ghost Flow Integration
  ghostFlowOrgId    String?  @unique  // Ghost Flow organization ID
  ghostFlowApiKey   String?           // Encrypted API key for sync
  
  // Profile
  displayName       String
  slug              String   @unique  // URL-friendly name
  bio               String?  @db.Text
  avatarUrl         String?
  websiteUrl        String?
  twitterHandle     String?
  githubHandle      String?
  
  // Verification
  verified          Boolean  @default(false)
  verifiedAt        DateTime?
  
  // Payout Configuration
  payoutMethod      PayoutMethod @default(USDC)
  payoutAddress     String?      // Wallet address for USDC/crypto
  stripeAccountId   String?      // Stripe Connect account ID
  
  // Stats (denormalized for performance)
  totalListings     Int      @default(0)
  totalInstalls     Int      @default(0)
  totalRevenue      Float    @default(0)
  avgRating         Float?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  listings          MarketplaceListing[]
  payouts           PublisherPayout[]
  analyticsEvents   AnalyticsEvent[]
  dailyStats        DailyStats[]
  
  @@index([slug])
  @@index([ghostFlowOrgId])
  @@index([verified])
}

// Marketplace Listing - supports all Ghost Flow creation types
model MarketplaceListing {
  id                  String   @id @default(cuid())
  publisherId         String
  publisher           Publisher @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  
  // Basic Info
  slug                String   @unique
  name                String
  shortDescription    String
  longDescription     String   @db.Text
  
  // Type (from Ghost Flow)
  type                ListingType
  category            String
  tags                String[]
  
  // Ghost Flow Reference
  ghostFlowId         String?  // ID in Ghost Flow system
  ghostFlowType       String?  // agent, workflow, swarm, etc.
  ghostFlowConfig     Json?    // Exported config from Ghost Flow
  
  // Technical Details
  supportedModels     String[] // ["gpt-4", "claude-3-opus", "gemini-pro"]
  availableTools      String[] // ["http", "filesystem", "database"]
  nodeCount           Int?     // For workflows/swarms
  estimatedLatency    Int?     // Avg execution time in ms
  
  // Pricing
  pricingModel        ListingPricingModel
  priceAmount         Float?   // In cents for per-call, dollars for others
  subscriptionMonthly Float?
  subscriptionYearly  Float?
  
  // Media
  coverImageUrl       String?
  screenshotUrls      String[]
  demoVideoUrl        String?
  
  // Status
  status              ListingStatus @default(PENDING)
  rejectionReason     String?
  
  // Verification
  verificationLevel   VerificationLevel @default(NONE)
  verifiedAt          DateTime?
  
  // Stats (denormalized)
  viewCount           Int      @default(0)
  installCount        Int      @default(0)
  totalRevenue        Float    @default(0)
  avgRating           Float?
  reviewCount         Int      @default(0)
  
  // Timestamps
  publishedAt         DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  installs            ListingInstall[]
  reviews             ListingReview[]
  analyticsEvents     AnalyticsEvent[]
  dailyStats          DailyStats[]
  transactions        X402Transaction[]
  
  @@index([slug])
  @@index([publisherId])
  @@index([type])
  @@index([category])
  @@index([status])
  @@index([pricingModel])
  @@index([verificationLevel])
  @@index([installCount])
  @@index([avgRating])
}

// Track listing installations/purchases
model ListingInstall {
  id                String   @id @default(cuid())
  listingId         String
  listing           MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  userId            String   // Buyer user ID
  
  // Install details
  installedAt       DateTime @default(now())
  uninstalledAt     DateTime?
  
  // For subscriptions
  subscriptionId    String?
  subscriptionEnds  DateTime?
  
  // Ghost Flow deployment reference
  ghostFlowDeployId String?
  
  @@unique([listingId, userId])
  @@index([listingId])
  @@index([userId])
}

// Reviews for marketplace listings
model ListingReview {
  id                String   @id @default(cuid())
  listingId         String
  listing           MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  userId            String   // Reviewer user ID
  
  rating            Int      // 1-5
  title             String?
  content           String?  @db.Text
  
  // Verification
  verifiedPurchase  Boolean  @default(false)
  
  // Moderation
  flagged           Boolean  @default(false)
  flagReason        String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([listingId, userId])
  @@index([listingId])
  @@index([userId])
  @@index([rating])
}

// x402 Micropayment Transactions
model X402Transaction {
  id                  String   @id @default(cuid())
  listingId           String
  listing             MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  // Parties
  buyerUserId         String
  publisherId         String
  
  // Payment Details
  amountCents         Int      // Amount in cents
  currency            String   @default("USD")
  
  // x402 Protocol Fields
  x402PaymentHash     String?  @unique // Payment hash for verification
  x402Receipt         Json?    // Full receipt from payment processor
  
  // Blockchain/Crypto Details (if applicable)
  chainId             Int?
  txHash              String?
  blockNumber         BigInt?
  tokenAddress        String?  // For stablecoin payments
  
  // Execution Context
  executionId         String?  // Ghost Flow execution ID
  inputHash           String?  // Hash of execution input
  outputHash          String?  // Hash of execution output
  
  status              TransactionStatus @default(PENDING)
  failureReason       String?
  
  createdAt           DateTime @default(now())
  completedAt         DateTime?
  
  @@index([listingId])
  @@index([buyerUserId])
  @@index([publisherId])
  @@index([status])
  @@index([createdAt])
}

// Publisher payouts (aggregated from transactions)
model PublisherPayout {
  id                  String   @id @default(cuid())
  publisherId         String
  publisher           Publisher @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  
  // Amount
  grossAmount         Float    // Total before fees
  platformFee         Float    // Evoworks platform fee
  netAmount           Float    // Amount to publisher
  currency            String   @default("USD")
  
  // Period
  periodStart         DateTime
  periodEnd           DateTime
  
  // Payout Method
  method              PayoutMethod
  destinationAddress  String?  // Wallet or bank details
  
  // Status
  status              PayoutStatus @default(PENDING)
  
  // Blockchain/Payment Details
  txHash              String?
  stripePayoutId      String?
  
  processedAt         DateTime?
  createdAt           DateTime @default(now())
  
  @@index([publisherId])
  @@index([status])
  @@index([periodEnd])
}

// ============================================================================
// ANALYTICS MODELS
// ============================================================================

// Track individual events for time-series analytics
model AnalyticsEvent {
  id              String   @id @default(cuid())
  
  // Event type
  eventType       AnalyticsEventType
  
  // References (at least one should be set)
  listingId       String?
  listing         MarketplaceListing? @relation(fields: [listingId], references: [id], onDelete: Cascade)
  publisherId     String?
  publisher       Publisher? @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  userId          String?
  user            User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Event data
  metadata        Json?    // Additional event-specific data
  
  // Context
  referrer        String?
  userAgent       String?
  country         String?
  sessionId       String?
  
  // Revenue (for transaction events)
  revenueAmount   Float?
  revenueCurrency String?
  
  timestamp       DateTime @default(now())
  
  @@index([eventType])
  @@index([listingId])
  @@index([publisherId])
  @@index([userId])
  @@index([timestamp])
  @@index([listingId, eventType, timestamp])
  @@index([publisherId, eventType, timestamp])
}

// Daily aggregated stats for faster queries
model DailyStats {
  id              String   @id @default(cuid())
  
  date            DateTime @db.Date
  
  // Scope (one should be set)
  listingId       String?
  listing         MarketplaceListing? @relation(fields: [listingId], references: [id], onDelete: Cascade)
  publisherId     String?
  publisher       Publisher? @relation(fields: [publisherId], references: [id], onDelete: Cascade)
  
  // Aggregated metrics
  views           Int      @default(0)
  uniqueViews     Int      @default(0)
  installs        Int      @default(0)
  uninstalls      Int      @default(0)
  executions      Int      @default(0)
  revenue         Float    @default(0)
  
  // Engagement
  avgSessionDuration Float? // seconds
  bounceRate      Float?   // percentage
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([date, listingId])
  @@unique([date, publisherId])
  @@index([date])
  @@index([listingId, date])
  @@index([publisherId, date])
}

// Platform-wide daily stats
model PlatformDailyStats {
  id              String   @id @default(cuid())
  
  date            DateTime @unique @db.Date
  
  // User metrics
  totalUsers      Int      @default(0)
  newUsers        Int      @default(0)
  activeUsers     Int      @default(0)
  
  // Listing metrics
  totalListings   Int      @default(0)
  newListings     Int      @default(0)
  activeListings  Int      @default(0)
  
  // Transaction metrics
  totalTransactions Int    @default(0)
  totalRevenue    Float    @default(0)
  avgTransactionValue Float @default(0)
  
  // Engagement
  totalViews      Int      @default(0)
  totalInstalls   Int      @default(0)
  totalExecutions Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([date])
}

// ============================================================================
// ENUMS
// ============================================================================

enum AnalyticsEventType {
  // Views
  LISTING_VIEW
  PUBLISHER_VIEW
  
  // Installs
  LISTING_INSTALL
  LISTING_UNINSTALL
  
  // Transactions
  TRANSACTION_STARTED
  TRANSACTION_COMPLETED
  TRANSACTION_FAILED
  
  // Executions
  EXECUTION_STARTED
  EXECUTION_COMPLETED
  EXECUTION_FAILED
  
  // Engagement
  LISTING_SEARCH
  LISTING_CLICK
  REVIEW_SUBMITTED
  
  // Auth
  USER_SIGNUP
  USER_LOGIN
}

enum Platform {
  N8N
  ZAPIER
  OPENAI
  MAKE
  WEBHOOK
  NATIVE
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  REVOKED
}

enum UserRole {
  BUYER
  CREATOR
  ADMIN
}

enum OrgRole {
  ORG_ADMIN
  BILLING_ADMIN
  POLICY_ADMIN
  AGENT_MANAGER
  TASK_CREATOR
  VIEWER
}

enum CredentialType {
  SLA_30D
  SLA_90D
  KYC_VERIFIED
  NO_PII_VIOLATIONS_90D
  HIPAA_COMPLIANT
  GDPR_COMPLIANT
  SOC2_COMPLIANT
  ORG_BINDING
  CUSTOM
}

enum ScorePeriod {
  DAYS_30
  DAYS_90
  DAYS_180
  ALL_TIME
}

enum StakeStatus {
  ACTIVE
  SLASHED
  WITHDRAWN
}

enum AuctionType {
  SEALED_BID
  VICKREY
  DIRECT
}

enum TaskStatus {
  DRAFT
  OPEN
  CLOSED
  ASSIGNED
  EXECUTING
  COMPLETED
  DISPUTED
  CANCELLED
}

enum BidStatus {
  PENDING
  REVEALED
  WON
  LOST
  WITHDRAWN
}

enum AssignmentStatus {
  ASSIGNED
  EXECUTING
  COMPLETED
  FAILED
  DISPUTED
}

enum ExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  TIMEOUT
}

enum PolicyDecisionType {
  ALLOW
  DENY
}

enum ApprovalType {
  AGENT_INSTALLATION
  HIGH_VALUE_TASK
  POLICY_CHANGE
  BUDGET_INCREASE
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
  SLASHED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
}

enum DisputeStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  CLOSED
}

enum PricingModel {
  FIXED
  HOURLY
  AUCTION
  SUBSCRIPTION
}

// ============================================================================
// EVOWORKS MARKETPLACE ENUMS
// ============================================================================

enum ListingType {
  AGENT
  WORKFLOW
  SWARM
  KNOWLEDGE_PACK
  TEMPLATE
  INTEGRATION
}

enum ListingPricingModel {
  FREE
  PER_CALL        // x402 micropayments
  SUBSCRIPTION
  ONE_TIME
}

enum ListingStatus {
  DRAFT
  PENDING         // Awaiting review
  ACTIVE
  PAUSED
  REJECTED
  ARCHIVED
}

enum VerificationLevel {
  NONE
  BASIC           // Email verified
  VERIFIED        // Full verification
  PARTNER         // Official partner
}

enum PayoutMethod {
  USDC            // USDC on Base/Ethereum
  ETH             // Native ETH
  STRIPE          // Traditional bank payout
  PAYPAL
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

